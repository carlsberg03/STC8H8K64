C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SEEKFREE_BLUETOOTH_CH9141
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_BLUETOOTH_CH9141.obj
COMPILER INVOKED BY: D:\Keil\Keil_5\C51\BIN\C51.EXE ..\..\Libraries\seekfree_peripheral\SEEKFREE_BLUETOOTH_CH9141.c LARG
                    -E OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seek
                    -free_peripheral;..\USER\inc;..\USER\src;..\CODE) DEBUG PRINT(.\Out_File\SEEKFREE_BLUETOOTH_CH9141.lst) TABS(2) OBJECT(.\
                    -Out_File\SEEKFREE_BLUETOOTH_CH9141.obj)

line level    source

   1          /*********************************************************************************************************
             -************
   2           * COPYRIGHT NOTICE
   3           * Copyright (c) 2021,Öð·É¿Æ¼¼
   4           * All rights reserved.
   5           * ¼¼ÊõÌÖÂÛQQÈº£ºÒ»Èº£º179029047(ÒÑÂú)  ¶þÈº£º244861897
   6           *
   7           * ÒÔÏÂËùÓÐÄÚÈÝ°æÈ¨¾ùÊôÖð·É¿Æ¼¼ËùÓÐ£¬Î´¾­ÔÊÐí²»µÃÓÃÓÚÉÌÒµÓÃÍ¾£¬
   8           * »¶Ó­¸÷Î»Ê¹ÓÃ²¢´«²¥±¾³ÌÐò£¬ÐÞ¸ÄÄÚÈÝÊ±±ØÐë±£ÁôÖð·É¿Æ¼¼µÄ°æÈ¨ÉùÃ÷¡£
   9           *
  10           * @file          Öð·É¿Æ¼¼À¶ÑÀ×ª´®¿ÚÄ£¿é
  11           * @company       ³É¶¼Öð·É¿Æ¼¼ÓÐÏÞ¹«Ë¾
  12           * @author        Öð·É¿Æ¼¼(QQ3184284598)
  13           * @version       ²é¿´docÄÚversionÎÄ¼þ °æ±¾ËµÃ÷
  14           * @Software    IAR 8.3 or MDK 5.33
  15           * @Taobao      https://seekfree.taobao.com/
  16           * @date          2021-08-27
  17           * @note    
  18                    ½ÓÏß¶¨Òå£º
  19                    ------------------------------------ 
  20                        À¶ÑÀ×ª´®¿Ú      µ¥Æ¬»ú                        
  21                        RX              ²é¿´SEEKFREE_BLUETOOTH_CH9141.hÎÄ¼þÖÐµÄBLUETOOTH_CH9141_UART_TXºê¶¨Òå
  22                        TX              ²é¿´SEEKFREE_BLUETOOTH_CH9141.hÎÄ¼þÖÐµÄBLUETOOTH_CH9141_UART_RXºê¶¨Òå
  23                        RTS             ²é¿´SEEKFREE_BLUETOOTH_CH9141.hÎÄ¼þÖÐµÄBLUETOOTH_CH9141_RTS_PINºê¶¨Òå
  24                                  CTS             Ðü¿Õ
  25                        CMD             Ðü¿Õ»òÕßÉÏÀ­
  26                    ------------------------------------ 
  27           *********************************************************************************************************
             -***********/
  28          #include "stdio.h"
  29          #include "string.h"
  30          #include "board.h"
  31          #include "zf_gpio.h"
  32          #include "zf_uart.h"
  33          #include "zf_nvic.h"
  34          #include "zf_delay.h"
  35          
  36          
  37          #include "SEEKFREE_BLUETOOTH_CH9141.h"
  38          
  39          
  40          uint8 uart_data;
  41          uint8 uart_flag;
  42          
  43          vuint8 at_mode = 0;         //0:À¶ÑÀÍ¸´«Ä£Ê½ 1:ATÄ£Ê½ 2:Ä£¿é¸´Î»ÖÐ
  44          vuint8 at_mode_num;         //atÄ£Ê½Ê±ÓÃÓÚÖ¸Ê¾Êý¾Ý½ÓÊÕµÄÊýÁ¿
  45          vuint8 at_mode_data[30];    //½ÓÊÕatÃüÁîµÄ»º´æ
  46          vuint8 at_mode_cmd_flag;    //OKÓ¦´ðÃüÁî½ÓÊÕ³É¹¦µÄ±êÖ¾Î»
  47          
  48          uint8 mac_address[17];      //±¾»úmacµØÖ·
  49          
  50          
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 2   

  51          uint8 bluetooth_ch9141_rx_buffer;
  52          
  53          
  54          void bluetooth_ch9141_check_response(void);
  55          
  56          //--------------------------------------------------------------------------------------------------------
             ------------
  57          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é ´®¿ÚÖÐ¶Ï»Øµ÷º¯Êý
  58          //  @param      NULL
  59          //  @return     void          
  60          //  @since      v1.0
  61          //  Sample usage: 
  62          //  @note       ¸Ãº¯ÊýÔÚISRÎÄ¼þ ´®¿Ú8ÖÐ¶Ï³ÌÐò±»µ÷ÓÃ
  63          //--------------------------------------------------------------------------------------------------------
             ------------
  64          void bluetooth_ch9141_uart_callback(void)
  65          {
  66   1          if(1 == at_mode)
  67   1          {
  68   2              //½øÈëATÄ£Ê½ ½ÓÊÕÓ¦´ðÐÅºÅ ´Ë´¦ifÓï¾äÄÚ´úÂëÓÃ»§²»Òª¸Ä¶¯
  69   2              //´Ë´¦ifÓï¾äÄÚ´úÂëÓÃ»§²»Òª¸Ä¶¯
  70   2              at_mode_data[at_mode_num++] = BLUETOOTH_CH9141_DATA_BUF;
  71   2              bluetooth_ch9141_check_response();
  72   2          }
  73   1          else if(2 == at_mode)
  74   1          {
  75   2              //Ä£¿éÕýÔÚ¸´Î»ÖÐ ´Ë´¦ifÓï¾äÄÚ´úÂëÓÃ»§²»Òª¸Ä¶¯
  76   2              //´Ë´¦ifÓï¾äÄÚ´úÂëÓÃ»§²»Òª¸Ä¶¯
  77   2              at_mode_num++;
  78   2          }
  79   1          else
  80   1          {
  81   2              //Í¸´«Ä£Ê½ ÓÃ»§ÔÚ´Ë´¦½ÓÊÕÅä¶ÔµÄÀ¶ÑÀ·¢ËÍ¹ýÀ´µÄ¶îÊý¾Ý
  82   2              //½Óµ½Ò»¸ö×Ö½Úºóµ¥Æ¬»ú½«»á½øÈë´Ë´¦£¬Í¨¹ýÔÚ´Ë´¦¶ÁÈ¡bluetooth_ch9141_rx_buffer¿ÉÒÔÈ¡×ßÊý¾Ý
  83   2              uart_data = BLUETOOTH_CH9141_DATA_BUF;
  84   2          }
  85   1              
  86   1      
  87   1      }
  88          
  89          //--------------------------------------------------------------------------------------------------------
             ------------
  90          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é¼ì²éOKÓ¦´ðÐÅºÅ
  91          //  @param      NULL
  92          //  @return     void          
  93          //  @since      v1.0
  94          //  Sample usage: 
  95          //  @note       ÓÃ»§ÎÞÐè¹ØÐÄ
  96          //--------------------------------------------------------------------------------------------------------
             ------------
  97          void bluetooth_ch9141_check_response(void)
  98          {
  99   1          if(4 <= at_mode_num)
 100   1          {
 101   2              if(0 == strncmp("OK\r\n", (int8 *)&at_mode_data[at_mode_num-4], 4))
 102   2              {
 103   3                  at_mode_cmd_flag = 1;
 104   3              }
 105   2          }
 106   1      }
 107          
 108          //--------------------------------------------------------------------------------------------------------
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 3   

             ------------
 109          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é·¢ËÍÒ»¸öÃ»ÓÐ²ÎÊýµÄÃüÁî²¢µÈ´ýÓ¦´ðÐÅºÅ
 110          //  @param      *str    ÐèÒª·¢ËÍµÄÃüÁî ÍêÕû×Ö·û´®
 111          //  @return     void          
 112          //  @since      v1.0
 113          //  Sample usage: 
 114          //  @note       ÓÃ»§ÎÞÐè¹ØÐÄ
 115          //--------------------------------------------------------------------------------------------------------
             ------------
 116          void bluetooth_ch9141_send_at_command(const int8 *str)
 117          {
 118   1          at_mode_num = 0;        //½ÓÊÕÊýÁ¿ÇåÁã
 119   1          uart_putstr(BLUETOOTH_CH9141_UART, str);
 120   1          uart_putstr(BLUETOOTH_CH9141_UART, "\r\n");
 121   1          
 122   1          //µÈ´ýÊÕµ½Ó¦´ðÐÅºÅ
 123   1          while(!at_mode_cmd_flag);
 124   1          at_mode_cmd_flag = 0;
 125   1      }
 126          
 127          //--------------------------------------------------------------------------------------------------------
             ------------
 128          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é·¢ËÍÒ»¸ö´øÓÐ²ÎÊýµÄÃüÁî²¢µÈ´ýÓ¦´ðÐÅºÅ
 129          //  @param      *cmd    ÐèÒª·¢ËÍµÄÃüÁîÃû³Æ
 130          //  @param      *dat   ÐèÒª·¢ËÍµÄÊý¾Ý
 131          //  @return     void          
 132          //  @since      v1.0
 133          //  Sample usage: 
 134          //  @note       ÓÃ»§ÎÞÐè¹ØÐÄ
 135          //--------------------------------------------------------------------------------------------------------
             ------------
 136          void bluetooth_ch9141_send_at_command_parameter(const int8 *cmd, const int8 *dat)
 137          {
 138   1          at_mode_num = 0;        //½ÓÊÕÊýÁ¿ÇåÁã
 139   1          uart_putstr(BLUETOOTH_CH9141_UART, "AT+");
 140   1          uart_putstr(BLUETOOTH_CH9141_UART, cmd);
 141   1          uart_putstr(BLUETOOTH_CH9141_UART, "=");
 142   1          uart_putstr(BLUETOOTH_CH9141_UART, dat);
 143   1          uart_putstr(BLUETOOTH_CH9141_UART, "\r\n");
 144   1          
 145   1          //µÈ´ýÊÕµ½Ó¦´ðÐÅºÅ
 146   1          while(!at_mode_cmd_flag);
 147   1          at_mode_cmd_flag = 0;
 148   1      }
 149          
 150          //--------------------------------------------------------------------------------------------------------
             ------------
 151          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é½øÈëATÄ£Ê½
 152          //  @param      NULL
 153          //  @return     void          
 154          //  @since      v1.0
 155          //  Sample usage: 
 156          //  @note       
 157          //--------------------------------------------------------------------------------------------------------
             ------------
 158          void bluetooth_ch9141_enter_at_mode(void)
 159          {
 160   1          delay_ms(600);  //·¢ËÍ½øÈëATÄ£Ê½µÄÃüÁîÇ°ÐèÒª±£Ö¤Ä£¿éÔÚ550msÄÚÃ»ÓÐ½ÓÊÕ¹ýÈÎºÎÊý¾Ý
 161   1          at_mode = 1;            //½øÈëATÄ£Ê½
 162   1          bluetooth_ch9141_send_at_command("AT...");
 163   1      }
 164          
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 4   

 165          //--------------------------------------------------------------------------------------------------------
             ------------
 166          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÍË³öATÄ£Ê½
 167          //  @param      NULL
 168          //  @return     void          
 169          //  @since      v1.0
 170          //  Sample usage: 
 171          //  @note       
 172          //--------------------------------------------------------------------------------------------------------
             ------------
 173          void bluetooth_ch9141_exit_at_mode(void)
 174          {
 175   1          bluetooth_ch9141_send_at_command("AT+EXIT");
 176   1          at_mode = 0;            //½øÈëÍ¸´«Ä£Ê½
 177   1          delay_ms(300);  //µÈ´ý³É¹¦½øÈëATÄ£Ê½
 178   1      }
 179          
 180          //--------------------------------------------------------------------------------------------------------
             ------------
 181          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é¸´Î»
 182          //  @param      NULL
 183          //  @return     void          
 184          //  @since      v1.0
 185          //  Sample usage: 
 186          //  @note       
 187          //--------------------------------------------------------------------------------------------------------
             ------------
 188          void bluetooth_ch9141_reset(void)
 189          {
 190   1          bluetooth_ch9141_send_at_command("AT+RESET");
 191   1          at_mode = 2;            //½øÈëÖØÆô³É¹¦¼ì²â
 192   1          at_mode_num = 0;
 193   1          while(7 > at_mode_num); //µÈ´ýÀ¶ÑÀÄ£¿éÍê³É¸´Î»
 194   1          at_mode = 0;            //¸´Î»Ö®ºóÄ£¿é×Ô¶¯½øÈëÍ¸´«Ä£Ê½
 195   1      }
 196          
 197          //--------------------------------------------------------------------------------------------------------
             ------------
 198          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é»ñÈ¡±¾»úMACµØÖ·
 199          //  @param      NULL
 200          //  @return     void          
 201          //  @since      v1.0
 202          //  Sample usage: 
 203          //  @note       µ÷ÓÃ´Ëº¯ÊýÐèÒªÏÈµ÷ÓÃbluetooth_ch9141_enter_at_mode»òÕßÀ­µÍCMDÒý½Å ½øÈëATÄ£Ê½
 204          //              ÐèÒªÌØ±ð×¢Òâbluetooth_ch9141_enter_at_modeº¯ÊýÄÚ²¿ÓÐ500msµÄÑÓÊ±
 205          //--------------------------------------------------------------------------------------------------------
             ------------
 206          void bluetooth_ch9141_get_mac_address(void)
 207          {
 208   1          bluetooth_ch9141_send_at_command("AT+MAC?");
 209   1          
 210   1          //macµØÖ·ÎªÐ¡¶Î¸ñÊ½£¬mac_address[0]±£´æµÄÊÇmacµØÖ·×îµÍÎ»
 211   1          memcpy(mac_address, (uint8 *)at_mode_data, 17);
 212   1      }
 213          
 214          //--------------------------------------------------------------------------------------------------------
             ------------
 215          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÉèÖÃ·¢ËÍ¹¦ÂÊ
 216          //  @param      tx_power    ÉèÖÃ·¢ËÍ¹¦ÂÊ£¬¿ÉÉèÖÃÑ¡Ïî²é¿´CH9141_TX_POWEER_enumÃ¶¾Ù³ÉÔ±
 217          //  @return     void          
 218          //  @since      v1.0
 219          //  Sample usage: 
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 5   

 220          //  @note       
 221          //--------------------------------------------------------------------------------------------------------
             ------------
 222          void bluetooth_ch9141_set_tx_power(CH9141_TX_POWEER_enum tx_power)
 223          {
 224   1          int8 tx_power_data;
 225   1          
 226   1          tx_power_data = (uint8)tx_power + '0';
 227   1          bluetooth_ch9141_send_at_command_parameter("TPL", &tx_power_data);
 228   1      }
 229          
 230          //--------------------------------------------------------------------------------------------------------
             ------------
 231          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÉèÖÃÄ£Ê½
 232          //  @param      mode    Ä£Ê½ÉèÖÃ£¬¿ÉÉèÖÃÑ¡Ïî²é¿´CH9141_MODE_enumÃ¶¾Ù³ÉÔ±
 233          //  @return     void          
 234          //  @since      v1.0
 235          //  Sample usage: 
 236          //  @note       
 237          //--------------------------------------------------------------------------------------------------------
             ------------
 238          void bluetooth_ch9141_set_mode(CH9141_MODE_enum mode)
 239          {
 240   1          int8 mode_data;
 241   1          
 242   1          mode_data = (uint8)mode + '0';
 243   1          bluetooth_ch9141_send_at_command_parameter("BLEMODE", &mode_data);
 244   1      }
 245          
 246          //--------------------------------------------------------------------------------------------------------
             ------------
 247          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é»ñÈ¡×´Ì¬
 248          //  @param      mode    Ä£Ê½ÉèÖÃ£¬¿ÉÉèÖÃÑ¡Ïî²é¿´CH9141_MODE_enumÃ¶¾Ù³ÉÔ±
 249          //  @return     CH9141_STATUS_enum  ·µ»Ø×´Ì¬ÐÅÏ¢
 250          //  @since      v1.0
 251          //  Sample usage: 
 252          //  @note       
 253          //--------------------------------------------------------------------------------------------------------
             ------------
 254          CH9141_STATUS_enum bluetooth_ch9141_get_status(CH9141_MODE_enum mode)
 255          {
 256   1          CH9141_STATUS_enum ch9141_status;
 257   1          int8 mode_data;
 258   1          
 259   1          mode_data = (uint8)mode + '0';
 260   1          bluetooth_ch9141_send_at_command_parameter("BLEMODE", &mode_data);
 261   1          
 262   1          bluetooth_ch9141_send_at_command("AT+BLESTA?");
 263   1          
 264   1          ch9141_status = (at_mode_data[0] - '0') * 10 + (at_mode_data[1] - '0');
 265   1          if(SLAVE_MODE == mode)
 266   1          {
 267   2              ch9141_status += SLAVE_NO_INIT;
 268   2          }
 269   1          
 270   1          return ch9141_status;
 271   1      }
 272          
 273          //--------------------------------------------------------------------------------------------------------
             ------------
 274          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÉèÖÃÉè±¸Ãû³Æ
 275          //  @param      *str    À¶ÑÀÃû³Æ
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 6   

 276          //  @return     void          
 277          //  @since      v1.0
 278          //  Sample usage: 
 279          //  @note       Ãû³Æ³¤¶È²»ÄÜ³¬¹ý18¸ö×Ö·û ÇÒÖ»ÄÜÎªÓ¢ÎÄÓëÊý×Ö
 280          //--------------------------------------------------------------------------------------------------------
             ------------
 281          void bluetooth_ch9141_set_name(const int8 *str)
 282          {
 283   1          bluetooth_ch9141_send_at_command_parameter("NAME", str);
 284   1          bluetooth_ch9141_send_at_command_parameter("PNAME", str);
 285   1      }
 286          
 287          //--------------------------------------------------------------------------------------------------------
             ------------
 288          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÃÜÂëÉèÖÃ
 289          //  @param      enable      Ê¹ÄÜÃÜÂë 0£º²»Ê¹ÓÃÃÜÂë£¬1£ºÊ¹ÓÃÃÜÂë²ÅÄÜÁ¬½Ó±¾Éè±¸
 290          //  @param      *password   ÃÜÂëµÄ×Ö·û´® ±ØÐëÎª6¸ö×Ö·û
 291          //  @return     void          
 292          //  @since      v1.0
 293          //  Sample usage: 
 294          //  @note       
 295          //--------------------------------------------------------------------------------------------------------
             ------------
 296          void bluetooth_ch9141_set_password(uint8 enable, const int8 *password)
 297          {
 298   1          if(0 == enable)
 299   1          {
 300   2              //¹Ø±ÕÃÜÂë
 301   2              bluetooth_ch9141_send_at_command_parameter("PASEN", "OFF");
 302   2          }
 303   1          else
 304   1          {
 305   2              //ÉèÖÃÃÜÂë²¢Ê¹ÄÜ
 306   2              bluetooth_ch9141_send_at_command_parameter("PASEN", "ON");
 307   2              bluetooth_ch9141_send_at_command_parameter("PASS", password);
 308   2          }
 309   1      }
 310          
 311          //--------------------------------------------------------------------------------------------------------
             ------------
 312          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÖ¸¶¨MACµØÖ·²¢Á¢¼´½øÐÐÁ¬½Ó
 313          //  @param      *mac_and_password      ÐèÒªÁ¬½ÓµÄÉè±¸macµØÖ·ÓëÃÜÂë
 314          //  @return     void          
 315          //  @since      v1.0
 316          //  Sample usage: 
 317          //  @note       bluetooth_ch9141_connect("58:B7:33:E4:C2:84,000000");
 318          //              58:B7:33:E4:C2:84ÎªmacµØÖ· ,Îª·Ö¸ô·û 000000Îª´Ó»úÀ¶ÑÀÃÜÂë
 319          //              ===================ÌØ±ð×¢Òâ==================
 320          //              Èç¹ûÊ¹ÓÃÊÖ»ú²é¿´À¶ÑÀµÄmacµØÖ·£¬ÔòÊ¹ÓÃ±¾º¯ÊýÁ¬½ÓµÄÊ±ºòÇë½«macµ¹ÖÃÒ»ÏÂ
 321          //              ÀýÈçÊÖ»ú²é¿´µ½µÄmacµØÖ·Îª61:62:63:64:65:66£¬ÔòÊ¹ÓÃ±¾º¯ÊýÁ¬½ÓµÄÊ±ºòÓ¦¸ÃÐ´
 322          //              bluetooth_ch9141_connect("66:65:64:63:62:61,000000");
 323          //--------------------------------------------------------------------------------------------------------
             ------------
 324          void bluetooth_ch9141_connect(const int8 *mac_and_password)
 325          {
 326   1          bluetooth_ch9141_send_at_command_parameter("CONN", mac_and_password);
 327   1      }
 328          
 329          //--------------------------------------------------------------------------------------------------------
             ------------
 330          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿éÄ¬ÈÏÁ¬½Ó²ÎÊýÉèÖÃ£¨ÉèÖÃºÃºó£¬Ã¿´Î¿ª»úÀ¶ÑÀ»á×Ô¶¯Á´½ÓÕâ¸öÉè±¸£©
 331          //  @param      *mac_and_password      ÐèÒªÁ¬½ÓµÄÉè±¸macµØÖ·ÓëÃÜÂë
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 7   

 332          //  @return     void          
 333          //  @since      v1.0
 334          //  Sample usage: 
 335          //  @note       bluetooth_ch9141_default_connect("58:B7:33:E4:C2:84,000000");
 336          //              58:B7:33:E4:C2:84ÎªmacµØÖ· ,Îª·Ö¸ô·û 000000Îª´Ó»úÀ¶ÑÀÃÜÂë
 337          //              ===================ÌØ±ð×¢Òâ==================
 338          //              Èç¹ûÊ¹ÓÃÊÖ»ú²é¿´CH9141µÄmacµØÖ·£¬½«CH9141ÉèÖÃÎª´Ó»ú£¬Ê¹ÓÃÊÖ»úÁ¬½Ó
 339          //              ÔòÊ¹ÓÃ±¾º¯ÊýÁ¬½ÓµÄÊ±ºòÇë½«macµ¹ÖÃÒ»ÏÂ
 340          //              ÀýÈçÊÖ»ú²é¿´µ½µÄmacµØÖ·Îª61:62:63:64:65:67£¬ÔòÊ¹ÓÃ±¾º¯ÊýÁ¬½ÓµÄÊ±ºòÓ¦¸ÃÐ´
 341          //              bluetooth_ch9141_default_connect("67:65:64:63:62:61,000000");
 342          //--------------------------------------------------------------------------------------------------------
             ------------
 343          void bluetooth_ch9141_default_connect(const int8 *mac_and_password)
 344          {
 345   1          bluetooth_ch9141_send_at_command_parameter("CONADD", mac_and_password);
 346   1      }
 347          
 348          //--------------------------------------------------------------------------------------------------------
             ------------
 349          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é»ñÈ¡rssi(ÐÅºÅÇ¿¶È)
 350          //  @param      void      
 351          //  @return     int8    ·µ»ØÐÅºÅÇ¿¶È0µ½-127
 352          //  @since      v1.0
 353          //  Sample usage: 
 354          //  @note       µ÷ÓÃ´Ëº¯ÊýÐèÒªÏÈµ÷ÓÃbluetooth_ch9141_enter_at_mode»òÕßÀ­µÍCMDÒý½Å ½øÈëATÄ£Ê½
 355          //              ÐèÒªÌØ±ð×¢Òâbluetooth_ch9141_enter_at_modeº¯ÊýÄÚ²¿ÓÐ500msµÄÑÓÊ±
 356          //--------------------------------------------------------------------------------------------------------
             ------------
 357          int16 bluetooth_ch9141_get_rssi(void)
 358          {
 359   1          uint8 i;
 360   1          size_t length;
 361   1          int16 rssi;
 362   1          bluetooth_ch9141_send_at_command_parameter("RSSI", "ON,0");
 363   1          length = strlen((int8 *)at_mode_data);
 364   1          length -= 12;//¼ÆËãRSSI ÓÐ¶àÉÙÎ»
 365   1          
 366   1          rssi = 0;
 367   1          for(i=0; i<length; i++)
 368   1          {
 369   2              rssi = rssi*10 + (at_mode_data[0] - '0');
 370   2          }
 371   1          
 372   1          return -rssi;
 373   1      }
 374          
 375          //--------------------------------------------------------------------------------------------------------
             ------------
 376          //  @brief      ÎÞÏß×ª´®¿ÚÄ£¿é ·¢ËÍº¯Êý
 377          //  @param      buff        ÐèÒª·¢ËÍµÄÊý¾ÝµØÖ·
 378          //  @param      len         ·¢ËÍ³¤¶È
 379          //  @return     uint32      Ê£ÓàÎ´·¢ËÍµÄ×Ö½ÚÊý   
 380          //  @since      v1.0
 381          //  Sample usage: 
 382          //  @note       
 383          //--------------------------------------------------------------------------------------------------------
             ------------
 384          uint32 bluetooth_ch9141_send_buff(uint8 *buff, uint32 len)
 385          {
 386   1          while(len)
 387   1          {
 388   2              //Á÷¿Ø¼ì²é RTSÎª¸ß±íÊ¾À¶ÑÀÄ£¿éÄÚ²¿»º³åÒÑÂúÎÞ·¨¼ÌÐø½ÓÊÕÊý¾Ý
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 8   

 389   2              
 390   2              //RTSÎª¸ß´¦Àí·½Ê½Ò»£ºÈç¹û¼ì²âµ½RTSÎª¸ßÔòºóÃæµÄÊý¾Ý²»ÔÙ¼ÌÐø·¢ËÍ£¬±ÜÃâ³öÏÖµÈ´ý
 391   2              if(BLUETOOTH_CH9141_RTS_PIN)  
 392   2              {
 393   3                  break;
 394   3              }
 395   2              
 396   2              //RTSÎª¸ß´¦Àí·½Ê½¶þ£ºÈç¹û¼ì²âµ½RTSÎª¸ßÔòµÈ´ýRTSÎªµÍÖ®ºó¼ÌÐø·¢ËÍÊý¾Ý
 397   2              //while(gpio_get(BLUETOOTH_CH9141_RTS_PIN));  //Èç¹ûRTSÎªµÍµçÆ½£¬Ôò¼ÌÐø·¢ËÍÊý¾Ý
 398   2              
 399   2              //·¢ËÍÊý¾Ý
 400   2              uart_putchar(BLUETOOTH_CH9141_UART, *buff);
 401   2      
 402   2              buff++;
 403   2              len--; 
 404   2          }
 405   1      
 406   1          return len;
 407   1      }
 408          
 409          
 410          
 411          
 412          
 413          //--------------------------------------------------------------------------------------------------------
             ------------
 414          //  @brief      À¶ÑÀ×ª´®¿ÚÄ£¿é³õÊ¼»¯
 415          //  @param      mode    À¶ÑÀÄ£Ê½ MASTER_MODE(Ö÷»ú)»òÕßSLAVE_MODE(´Ó»ú)
 416          //  @return     void          
 417          //  @since      v1.0
 418          //  Sample usage: 
 419          //  @note       
 420          //--------------------------------------------------------------------------------------------------------
             ------------
 421          void bluetooth_ch9141_init(CH9141_MODE_enum mode, int8 *salve_mac_password)
 422          {
 423   1      
 424   1          //===================ÌØ±ð×¢Òâ==================
 425   1          //Èç¹ûÊ¹ÓÃÊÖ»ú²é¿´À¶ÑÀµÄmacµØÖ·£¬ÔòÊ¹ÓÃ±¾º¯ÊýÁ¬½ÓµÄÊ±ºòÇë½«macµ¹ÖÃÒ»ÏÂ
 426   1          //ÀýÈçÊÖ»ú²é¿´µ½µÄmacµØÖ·Îª61:62:63:64:65:66£¬ÔòÊ¹ÓÃ±¾º¯ÊýÁ¬½ÓµÄÊ±ºòÓ¦¸ÃÐ´
 427   1          //bluetooth_ch9141_connect("66:65:64:63:62:61,000000");
 428   1          //58:B7:33:E4:C2:84ÎªmacµØÖ· ,Îª·Ö¸ô·û 000000Îª´Ó»úÀ¶ÑÀÃÜÂë
 429   1          //´Ó»úMACµØÖ·ÓëÃÜÂë
 430   1      
 431   1      
 432   1          //±¾º¯ÊýÊ¹ÓÃµÄ²¨ÌØÂÊÎª115200£¬ÎªÀ¶ÑÀ×ª´®¿ÚÄ£¿éµÄÄ¬ÈÏ²¨ÌØÂÊ£¬ÈçÐèÆäËû²¨ÌØÂÊÇëÊ¹ÓÃÉÏÎ»»úÐÞ¸ÄÄ£¿é²ÎÊý
 433   1          //³õÊ¼»¯Á÷¿ØÒý½Å
 434   1          wireless_type = WIRELESS_CH9141;
 435   1          //Èç¹û²»½ÓRTSÒý½Å£¬ÔòRTSÒý½ÅÄ¬ÈÏÎª¸ßµçÆ½£¬ÕâÀïÐèÒª½«ÆäÉèÖÃÎªµÍµçÆ½¡£
 436   1          BLUETOOTH_CH9141_RTS_PIN = 0;
 437   1          //³õÊ¼»¯´®¿Ú
 438   1          uart_init (BLUETOOTH_CH9141_UART, BLUETOOTH_CH9141_UART_RX, BLUETOOTH_CH9141_UART_TX, BLUETOOTH_CH9141
             -_UART_BAUD, BLUETOOTH_CH9141_TIMER_N);  //³õÊ¼»»´®¿Ú    
 439   1      
 440   1          EnableGlobalIRQ();
 441   1          
 442   1          //À¶ÑÀ·ÖÎªÖ÷»úÓë´Ó»úÄ£Ê½£¬Á½¸öÀ¶ÑÀÏëÒªÁ¬½Ó³É¹¦¾Í±ØÐëÓÐÒ»¸öÎªÖ÷»ú£¬ÓÐÒ»¸öÎª´Ó»ú£¬ËùÒÔµ÷ÓÃ³õÊ¼»¯µÄÊ±ºòÐè
             -ÒªºÏÀíµÄÌîÐ´º¯Êý²ÎÊý²ÅÄÜ³É¹¦µÄÁ¬½Ó
 443   1          //À¶ÑÀ·ÖÎªÖ÷»úÓë´Ó»úÄ£Ê½£¬Á½¸öÀ¶ÑÀÏëÒªÁ¬½Ó³É¹¦¾Í±ØÐëÓÐÒ»¸öÎªÖ÷»ú£¬ÓÐÒ»¸öÎª´Ó»ú£¬ËùÒÔµ÷ÓÃ³õÊ¼»¯µÄÊ±ºòÐè
             -ÒªºÏÀíµÄÌîÐ´º¯Êý²ÎÊý²ÅÄÜ³É¹¦µÄÁ¬½Ó
 444   1          //ÉÏµçË³Ðò£º×îºÃ´Ó»úÏÈÉÏµç£¬È»ºóÖ÷»úÔÙÉÏµç
 445   1      
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 9   

 446   1          if(MASTER_MODE == mode)
 447   1          {
 448   2              //1.½«À¶ÑÀÉèÖÃÎªÖ÷»úÄ£Ê½£¬È»ºóÁ¬½ÓÖ¸¶¨macµØÖ·µÄ´Ó»úÉè±¸
 449   2      
 450   2              bluetooth_ch9141_enter_at_mode();  //½øÈëATÄ£Ê½
 451   2              bluetooth_ch9141_set_mode(mode);   //ÉèÖÃÀ¶ÑÀÄ£Ê½
 452   2              bluetooth_ch9141_get_mac_address();//»ñÈ¡±¾»úMACµØÖ·
 453   2          bluetooth_ch9141_reset();                  //ÉèÖÃÍê³ÉºóÐèÒª¸´Î»£¬ÉèÖÃ²Å»áÉúÐ§
 454   2          bluetooth_ch9141_enter_at_mode();          //½øÈëATÄ£Ê½
 455   2      
 456   2          //ÉèÖÃÍêÄ£Ê½Ö®ºóÐèÒª¸´Î»È»ºóÔÙ´Î½øÈëATÄ£Ê½²ÅÄÜ¼ÌÐøÉèÖÃÆäËû²ÎÊý£¬·ñÔòÄ£Ê½ÉèÖÃ²»³É¹¦
 457   2              bluetooth_ch9141_set_tx_power(TX_POWER_4DB);//ÉèÖÃÀ¶ÑÀ·¢ËÍ¹¦ÂÊ
 458   2      
 459   2              
 460   2              bluetooth_ch9141_default_connect(salve_mac_password);  //ÅäÖÃÄ¬ÈÏÁ¬½Ó²ÎÊý£¬¼´Ê¹ÏÂ´Î²»ÅäÖÃÒ²»á×Ô¶¯Á
             -¬½Ó´Ó»ú
 461   2              bluetooth_ch9141_connect(salve_mac_password);          //Á¢¼´Á¬½ÓÉèÖÃµÄ´Ó»úµØÖ·
 462   2      
 463   2              //µÈ´ýÁ¬½Ó³É¹¦
 464   2              while(MASTER_CONNECTED != bluetooth_ch9141_get_status(mode));
 465   2              bluetooth_ch9141_exit_at_mode();                       //ÍË³öATÄ£Ê½
 466   2          }
 467   1          else if(SLAVE_MODE == mode)
 468   1          {
 469   2              //2.À¶ÑÀÉèÖÃÎª´Ó»ú²¢µÈ´ýÁ¬½Ó
 470   2              bluetooth_ch9141_enter_at_mode();  //½øÈëATÄ£Ê½
 471   2              bluetooth_ch9141_set_mode(mode);   //ÉèÖÃÀ¶ÑÀÄ£Ê½
 472   2              bluetooth_ch9141_get_mac_address();//»ñÈ¡±¾»úMACµØÖ·
 473   2          bluetooth_ch9141_reset();                  //ÉèÖÃÍê³ÉºóÐèÒª¸´Î»£¬ÉèÖÃ²Å»áÉúÐ§
 474   2          bluetooth_ch9141_enter_at_mode();          //½øÈëATÄ£Ê½
 475   2      
 476   2          //ÉèÖÃÍêÄ£Ê½Ö®ºóÐèÒª¸´Î»È»ºóÔÙ´Î½øÈëATÄ£Ê½²ÅÄÜ¼ÌÐøÉèÖÃÆäËû²ÎÊý£¬·ñÔòÄ£Ê½ÉèÖÃ²»³É¹¦
 477   2              bluetooth_ch9141_set_tx_power(TX_POWER_4DB);//ÉèÖÃÀ¶ÑÀ·¢ËÍ¹¦ÂÊ
 478   2              bluetooth_ch9141_set_name("ble");
 479   2              bluetooth_ch9141_set_password(1, "000000");  //000000ÎªÀ¶ÑÀÃÜÂë¿ÉÒÔ×Ô¼ºÐÞ¸Ä
 480   2              bluetooth_ch9141_reset();                  //ÉèÖÃÍê³ÉºóÐèÒª¸´Î»£¬ÉèÖÃ²Å»áÉúÐ§
 481   2              bluetooth_ch9141_enter_at_mode();          //½øÈëATÄ£Ê½
 482   2              //µÈ´ýÁ¬½Ó³É¹¦
 483   2              while(SLAVE_CONNECTED != bluetooth_ch9141_get_status(mode));
 484   2              bluetooth_ch9141_exit_at_mode();           //ÍË³öATÄ£Ê½
 485   2          }
 486   1          
 487   1          //Èç¹ûÏë»ñÈ¡ÎÞÏßÐÅºÅÇ¿¶È¿ÉÒÔ°´ÕÕÏÂÃæµÄÊ¾Àýµ÷ÓÃ
 488   1          //bluetooth_ch9141_enter_at_mode();
 489   1          //int16 rssi = bluetooth_ch9141_get_rssi();
 490   1          
 491   1          DisableGlobalIRQ();
 492   1      }
 493          
 494          
 495          
 496          
 497          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1160    ----
   CONSTANT SIZE    =    130    ----
   XDATA SIZE       =     53      37
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.00   SEEKFREE_BLUETOOTH_CH9141                                             05/18/2022 20:21:35 PAGE 10  

   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
